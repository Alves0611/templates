name: Core Terraform Pipeline

on:
  workflow_call:
    inputs:
      aws_region:
        required: true
        type: string
        description: AWS region to use
      tf_version:
        required: false
        type: string
        default: "1.7.5"
        description: Terraform version to use
      working_directory:
        required: false
        type: string
        default: "."
        description: Working directory for Terraform operations
      backend_config_file:
        required: false
        type: string
        default: ""
        description: Optional backend config file path
      enable_infracost:
        required: false
        type: boolean
        default: true
        description: Enable Infracost cost estimation
      enable_trivy:
        required: false
        type: boolean
        default: true
        description: Enable Trivy security scanning
      enable_checkov:
        required: false
        type: boolean
        default: true
        description: Enable Checkov security scanning
      enable_tflint:
        required: false
        type: boolean
        default: true
        description: Enable TFLint
      enable_tfsec:
        required: false
        type: boolean
        default: false
        description: Enable TFSec security scanning
      plan_on_push_main:
        required: false
        type: boolean
        default: true
        description: Run plan on push to main branch
      apply_on_push_main:
        required: false
        type: boolean
        default: true
        description: Run apply on push to main branch
      comment_plan_on_pr:
        required: false
        type: boolean
        default: true
        description: Comment plan output on PR
    secrets:
      AWS_ASSUME_ROLE:
        required: true
        description: ARN of the OIDC role to assume for all operations
      INFRACOST_API_KEY:
        required: false
        description: Infracost API key for cost estimation
  workflow_dispatch:
    inputs:
      mode:
        required: true
        type: choice
        options:
          - pr
          - apply
        description: Pipeline mode (pr or apply)
      run_apply:
        required: false
        type: boolean
        default: false
        description: Actually run apply (only for mode=apply)

jobs:
  SetVars:
    name: Set Variables
    runs-on: ubuntu-latest
    steps:
      - name: Validate apply configuration
        run: |
          APPLY_ON_PUSH="${{ inputs.apply_on_push_main }}"
          PLAN_ON_PUSH="${{ inputs.plan_on_push_main }}"
          echo "APPLY_ON_PUSH=$APPLY_ON_PUSH"
          echo "PLAN_ON_PUSH=$PLAN_ON_PUSH"
          if [ "$APPLY_ON_PUSH" = "true" ] && [ "$PLAN_ON_PUSH" = "false" ]; then
            echo "::error::apply_on_push_main=true requires plan_on_push_main=true. Cannot apply without running plan first."
            exit 1
          fi
          echo "Validation passed"

  debug-context:
    name: Debug Context
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: always()
    steps:
      - name: Show context
        run: |
          echo "event_name: ${{ github.event_name }}"
          echo "ref: ${{ github.ref }}"
          echo "plan_on_push_main: ${{ inputs.plan_on_push_main }}"
          echo "apply_on_push_main: ${{ inputs.apply_on_push_main }}"
          echo "mode: ${{ inputs.mode }}"
          echo "run_apply: ${{ inputs.run_apply }}"

  terraform-plan:
    name: Terraform Plan
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_call' && github.ref != 'refs/heads/main') ||
      ((github.event_name == 'push' || github.event_name == 'workflow_call') &&
       github.ref == 'refs/heads/main' &&
       (inputs.plan_on_push_main || inputs.apply_on_push_main)) ||
      (github.event_name == 'workflow_dispatch' && (inputs.mode == 'pr' || (inputs.mode == 'apply' && inputs.run_apply)))
    needs: [validate-inputs, debug-context]
    uses: ./.github/workflows/terraform-plan.yml
    with:
      tf_version: ${{ inputs.tf_version }}
      working_directory: ${{ inputs.working_directory }}
      aws_region: ${{ inputs.aws_region }}
      backend_config_file: ${{ inputs.backend_config_file }}
      enable_infracost: ${{ (github.event_name == 'pull_request' || (github.event_name == 'workflow_call' && github.ref != 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && inputs.mode == 'pr')) && inputs.enable_infracost }}
      enable_trivy: ${{ inputs.enable_trivy }}
      enable_checkov: ${{ inputs.enable_checkov }}
      enable_tflint: ${{ inputs.enable_tflint }}
      enable_tfsec: ${{ inputs.enable_tfsec }}
      comment_plan_on_pr: ${{ (github.event_name == 'pull_request' || (github.event_name == 'workflow_call' && github.ref != 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && inputs.mode == 'pr')) && inputs.comment_plan_on_pr }}
      artifact_name: tfplan
    secrets:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ASSUME_ROLE }}
      INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
    permissions:
      id-token: write
      contents: read
      pull-requests: write

  terraform-apply:
    name: Terraform Apply
    if: |
      ((github.event_name == 'push' || github.event_name == 'workflow_call') &&
       github.ref == 'refs/heads/main' &&
       inputs.apply_on_push_main) ||
      (github.event_name == 'workflow_dispatch' && inputs.mode == 'apply' && inputs.run_apply)
    needs: terraform-plan
    uses: ./.github/workflows/terraform-apply.yml
    with:
      tf_version: ${{ inputs.tf_version }}
      working_directory: ${{ inputs.working_directory }}
      aws_region: ${{ inputs.aws_region }}
      backend_config_file: ${{ inputs.backend_config_file }}
      artifact_name: tfplan
    secrets:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ASSUME_ROLE }}
    permissions:
      id-token: write
      contents: read
