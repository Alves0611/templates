name: Terraform Plan

on:
  workflow_call:
    inputs:
      tf_version:
        required: false
        type: string
        default: "1.7.5"
      working_directory:
        required: false
        type: string
        default: "."
      aws_region:
        required: true
        type: string
      backend_config_file:
        required: false
        type: string
        default: ""
      enable_trivy:
        required: false
        type: boolean
        default: true
      enable_checkov:
        required: false
        type: boolean
        default: true
      enable_tfsec:
        required: false
        type: boolean
        default: false
      enable_tflint:
        required: false
        type: boolean
        default: true
      enable_infracost:
        required: false
        type: boolean
        default: true
      comment_plan_on_pr:
        required: false
        type: boolean
        default: true
      artifact_name:
        required: false
        type: string
        default: "tfplan"
    secrets:
      AWS_ROLE_TO_ASSUME:
        required: true
        description: ARN of the OIDC role to assume
      INFRACOST_API_KEY:
        required: false

jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout templates repository
        uses: actions/checkout@v4
        with:
          repository: Alves0611/templates
          path: .github-templates
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform
        uses: ./.github-templates/actions/setup-terraform
        with:
          tf_version: ${{ inputs.tf_version }}
          enable_tflint: ${{ inputs.enable_tflint }}
          enable_tfsec: ${{ inputs.enable_tfsec }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: terraform-plan-${{ github.run_id }}
          aws-region: ${{ inputs.aws_region }}

      - name: Verify working directory exists
        run: |
          if [ ! -d "${{ inputs.working_directory }}" ]; then
            echo "::error::Working directory '${{ inputs.working_directory }}' does not exist in this repository."
            echo "Available directories:"
            ls -la
            echo ""
            echo "Please check your workflow configuration:"
            echo "  - If Terraform files are in the root, use: working_directory: '.'"
            echo "  - If Terraform files are in a subdirectory, use the correct path"
            echo "  - Default value is '.' (current directory)"
            exit 1
          fi
          echo "Working directory: ${{ inputs.working_directory }}"
          echo "Contents:"
          ls -la "${{ inputs.working_directory }}"

      - name: Terraform Format Check
        working-directory: ${{ inputs.working_directory }}
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "Running terraform init..."
          if [ -n "${{ inputs.backend_config_file }}" ]; then
            echo "Using backend config file: ${{ inputs.backend_config_file }}"
            terraform init -backend-config="${{ inputs.backend_config_file }}" -no-color
          else
            echo "Running terraform init without backend config"
            terraform init -no-color
          fi
          echo "Terraform init completed. Exit code: $?"
          terraform version

      - name: Terraform Validate
        working-directory: ${{ inputs.working_directory }}
        run: terraform validate -no-color

      - name: Setup Trivy
        if: inputs.enable_trivy == true
        uses: aquasecurity/setup-trivy@v0.2.3
        with:
          version: "latest"

      - name: Run Trivy
        id: trivy
        if: inputs.enable_trivy == true
        working-directory: ${{ inputs.working_directory }}
        run: |
          trivy config --severity CRITICAL,HIGH --exit-code 1 --format json --output trivy-results.json . || true
          if [ -f "trivy-results.json" ]; then
            CRITICAL=$(jq '[.[]?.Results[]?.Misconfigurations[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json 2>/dev/null || jq '[.Results[]?.Misconfigurations[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.[]?.Results[]?.Misconfigurations[]? | select(.Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || jq '[.Results[]?.Misconfigurations[]? | select(.Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            TOTAL=$((CRITICAL + HIGH))
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Set Trivy Defaults
        if: inputs.enable_trivy != true
        run: |
          echo "critical=0" >> $GITHUB_OUTPUT
          echo "high=0" >> $GITHUB_OUTPUT
          echo "total=0" >> $GITHUB_OUTPUT

      - name: Install Checkov
        if: inputs.enable_checkov == true
        run: |
          pip install checkov

      - name: Run Checkov
        id: checkov
        if: inputs.enable_checkov == true
        working-directory: ${{ inputs.working_directory }}
        run: |
          checkov -d . --framework terraform --output json --output-file-path checkov-results.json || true
          if [ -f "checkov-results.json" ]; then
            echo "Checkov JSON file found, parsing..."
            # Try different JSON structures
            FAILED=$(jq -r '.summary.failed // .summary.failed // 0' checkov-results.json 2>/dev/null || echo "0")
            PASSED=$(jq -r '.summary.passed // .summary.passed // 0' checkov-results.json 2>/dev/null || echo "0")
            # If still 0, try counting from check_results
            if [ "$FAILED" = "0" ] && [ "$PASSED" = "0" ]; then
              FAILED=$(jq '[.check_results[]?.check_result.failed] | length' checkov-results.json 2>/dev/null || echo "0")
              PASSED=$(jq '[.check_results[]?.check_result.passed] | length' checkov-results.json 2>/dev/null || echo "0")
            fi
            # Count from results array
            if [ "$FAILED" = "0" ] && [ "$PASSED" = "0" ]; then
              FAILED=$(jq '[.results[]?.check_result | select(.result == "FAILED")] | length' checkov-results.json 2>/dev/null || echo "0")
              PASSED=$(jq '[.results[]?.check_result | select(.result == "PASSED")] | length' checkov-results.json 2>/dev/null || echo "0")
            fi
            echo "Checkov results: passed=$PASSED, failed=$FAILED"
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
          else
            echo "Checkov JSON file not found"
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Set Checkov Defaults
        if: inputs.enable_checkov != true
        run: |
          echo "failed=0" >> $GITHUB_OUTPUT
          echo "passed=0" >> $GITHUB_OUTPUT

      - name: Run TFSec
        if: inputs.enable_tfsec == true
        working-directory: ${{ inputs.working_directory }}
        run: |
          tfsec . --minimum-severity HIGH --format compact
        continue-on-error: false

      - name: Run TFLint
        if: inputs.enable_tflint == true
        working-directory: ${{ inputs.working_directory }}
        run: |
          tflint --init
          tflint -f compact

      - name: Terraform Plan
        id: plan
        working-directory: ${{ inputs.working_directory }}
        run: |
          terraform plan -out=${{ inputs.artifact_name }} -no-color
          echo "plan_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.working_directory }}/${{ inputs.artifact_name }}
          retention-days: 5

      - name: Setup Infracost
        if: inputs.enable_infracost == true
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

      - name: Generate Infracost Report
        id: infracost
        if: inputs.enable_infracost == true
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "Running Infracost breakdown..."
          # Convert terraform plan to JSON format
          terraform show -json ${{ inputs.artifact_name }} > plan.json || true
          if [ -f "plan.json" ]; then
            echo "Plan JSON generated, running Infracost..."
            infracost breakdown --path plan.json --format json --out-file infracost.json || true
          else
            echo "Failed to generate plan.json, trying direct path..."
            # Fallback: try using the directory directly
            infracost breakdown --path . --format json --out-file infracost.json || true
          fi
          if [ -f "infracost.json" ]; then
            echo "Infracost JSON file found, parsing..."
            # Try different JSON structures
            TOTAL_COST=$(jq -r '.projects[0].breakdown.totalMonthlyCost // empty' infracost.json 2>/dev/null)
            if [ -z "$TOTAL_COST" ] || [ "$TOTAL_COST" = "null" ]; then
              TOTAL_COST=$(jq -r '.totalMonthlyCost // empty' infracost.json 2>/dev/null)
            fi
            if [ -z "$TOTAL_COST" ] || [ "$TOTAL_COST" = "null" ]; then
              TOTAL_COST=$(jq -r '.projects[0].summary.totalMonthlyCost // empty' infracost.json 2>/dev/null)
            fi
            echo "Infracost cost extracted: $TOTAL_COST"
            if [ -n "$TOTAL_COST" ] && [ "$TOTAL_COST" != "null" ] && [ "$TOTAL_COST" != "0" ] && [ "$TOTAL_COST" != "0.0" ]; then
              echo "cost=$TOTAL_COST" >> $GITHUB_OUTPUT
              echo "found=true" >> $GITHUB_OUTPUT
            else
              echo "found=false" >> $GITHUB_OUTPUT
              echo "cost=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "Infracost JSON file not found"
            echo "found=false" >> $GITHUB_OUTPUT
            echo "cost=0" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Set Infracost Defaults
        if: inputs.enable_infracost != true
        run: |
          echo "found=false" >> $GITHUB_OUTPUT
          echo "cost=0" >> $GITHUB_OUTPUT

      - name: Upload Infracost Artifact
        if: inputs.enable_infracost == true
        uses: actions/upload-artifact@v4
        with:
          name: infracost.json
          path: ${{ inputs.working_directory }}/infracost.json
          retention-days: 5
        continue-on-error: true

      - name: Comment Infracost on PR
        if: |
          inputs.enable_infracost == true &&
          inputs.comment_plan_on_pr == true &&
          github.event_name == 'pull_request'
        uses: infracost/actions/comment@v1
        with:
          path: ${{ inputs.working_directory }}/infracost.json
          behavior: update
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment Plan Summary on PR
        if: |
          inputs.comment_plan_on_pr == true &&
          github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const planFile = path.join('${{ inputs.working_directory }}', '${{ inputs.artifact_name }}');

            let comment = '## ğŸ“‹ Terraform Plan Summary\n\n';
            comment += `âœ… Plan completed successfully\n\n`;
            comment += `ğŸ“¦ Plan artifact: \`${{ inputs.artifact_name }}\`\n\n`;
            comment += `ğŸ”— Download the plan artifact from the workflow run artifacts.\n\n`;

            if ('${{ inputs.enable_infracost }}' === 'true') {
              comment += `ğŸ’° Cost estimation: See Infracost comment below\n\n`;
            }

            comment += `---\n*Generated by terraform-pipeline*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Format Summary Data
        id: summary
        if: always()
        run: |
          if [ "${{ inputs.enable_trivy }}" = "true" ]; then
            TRIVY_TEXT="âœ… ${{ steps.trivy.outputs.total }} issues (CRITICAL: ${{ steps.trivy.outputs.critical }}, HIGH: ${{ steps.trivy.outputs.high }})"
            if [ "${{ steps.trivy.outputs.total }}" = "0" ]; then
              TRIVY_TEXT="âœ… No issues found"
            fi
          else
            TRIVY_TEXT="â­ï¸ Disabled"
          fi
          echo "trivy_text=$TRIVY_TEXT" >> $GITHUB_OUTPUT

          if [ "${{ inputs.enable_checkov }}" = "true" ]; then
            CHECKOV_TEXT="âœ… ${{ steps.checkov.outputs.passed }} passed, ${{ steps.checkov.outputs.failed }} failed"
          else
            CHECKOV_TEXT="â­ï¸ Disabled"
          fi
          echo "checkov_text=$CHECKOV_TEXT" >> $GITHUB_OUTPUT

          if [ "${{ inputs.enable_infracost }}" = "true" ]; then
            if [ "${{ steps.infracost.outputs.found }}" = "true" ]; then
              INFRACOST_TEXT="ğŸ’° ${{ steps.infracost.outputs.cost }}/month"
            else
              INFRACOST_TEXT="âœ… Enabled (no cost data)"
            fi
          else
            INFRACOST_TEXT="â­ï¸ Disabled"
          fi
          echo "infracost_text=$INFRACOST_TEXT" >> $GITHUB_OUTPUT

      - name: Render Summary
        uses: ./.github-templates/actions/render-summary
        if: always()
        with:
          title: "Terraform Plan Summary"
          lines: |
            - **Format Check**: ${{ steps.plan.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Validate**: ${{ steps.plan.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
            - **Trivy**: ${{ steps.summary.outputs.trivy_text }}
            - **Checkov**: ${{ steps.summary.outputs.checkov_text }}
            - **TFSec**: ${{ inputs.enable_tfsec && 'âœ… Enabled' || 'â­ï¸ Disabled' }}
            - **TFLint**: ${{ inputs.enable_tflint && 'âœ… Enabled' || 'â­ï¸ Disabled' }}
            - **Plan**: ${{ steps.plan.outcome == 'success' && 'âœ… Generated' || 'âŒ Failed' }}
            - **Plan Artifact**: `${{ inputs.artifact_name }}`
            - **Infracost**: ${{ steps.summary.outputs.infracost_text }}
            - **PR Comment**: ${{ inputs.comment_plan_on_pr && github.event_name == 'pull_request' && 'âœ… Enabled' || 'â­ï¸ Disabled' }}
